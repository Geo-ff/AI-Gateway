openapi: 3.0.3
info:
  title: Gateway Zero API
  description: |
    Gateway Zero 是一个基于 Rust 和 Axum 框架开发的 AI API 网关系统。
    它提供统一的 OpenAI 兼容接口，支持多个 AI 提供商（OpenAI、Anthropic、智谱 AI 等），
    并具备负载均衡、令牌管理、用量统计等企业级功能。
  version: 0.1.0
  contact:
    name: Gateway Zero Team

servers:
  - url: http://localhost:8080
    description: 本地开发服务器
  - url: https://api.example.com
    description: 生产环境服务器

components:
  securitySchemes:
    # Client Token：外部调用 /v1/* 的 API Token（与 Admin Identity 严格区分）
    ClientToken:
      type: apiKey
      in: header
      name: Authorization
      description: "Client Token 认证（格式: Bearer <token>），用于访问 `/v1/*`"

    # Admin Identity：管理员身份（可来自 JWT AccessToken / TUI Session bearer / Web Session Cookie）
    AdminTuiSessionToken:
      type: http
      scheme: bearer
      description: 管理员身份（Admin Identity）的 TUI Session Token（bearer，但非 JWT）

    AdminSessionCookie:
      type: apiKey
      in: cookie
      name: gw_session
      description: 管理员身份（Admin Identity）的 Web Session Cookie（HttpOnly）

    AccessToken:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "AccessToken（JWT），格式: Bearer <jwt>；用于访问 `/auth/me`、`/auth/change-password`、`/me/*` 以及 superadmin-only 的 `/admin/*`、`/providers/*`"

  schemas:
    # 错误响应
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: 错误代码 (如 http_error, not_found, rate_limited 等)
        message:
          type: string
          description: 错误详细信息

    # 请求日志
    RequestLog:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: 日志ID
        timestamp:
          type: string
          format: date-time
          description: 请求时间戳
        method:
          type: string
          description: HTTP 方法
        path:
          type: string
          description: 请求路径
        request_type:
          type: string
          description: 请求类型
        model:
          type: string
          nullable: true
          description: 使用的模型
        provider:
          type: string
          nullable: true
          description: 提供商名称
        api_key:
          type: string
          nullable: true
          description: API Key (可能被脱敏)
        client_token:
          type: string
          nullable: true
          description: 客户端令牌
        amount_spent:
          type: number
          format: double
          nullable: true
          description: 本次请求消耗的金额
        status_code:
          type: integer
          description: HTTP 状态码
        response_time_ms:
          type: integer
          format: int64
          description: 响应时间(毫秒)
        prompt_tokens:
          type: integer
          nullable: true
          description: 提示词 tokens
        completion_tokens:
          type: integer
          nullable: true
          description: 补全 tokens
        total_tokens:
          type: integer
          nullable: true
          description: 总 tokens
        cached_tokens:
          type: integer
          nullable: true
          description: 缓存 tokens
        reasoning_tokens:
          type: integer
          nullable: true
          description: 推理 tokens
        error_message:
          type: string
          nullable: true
          description: 错误信息

    # 管理端：请求日志查询（/admin/logs/*）
    RequestLogEntry:
      type: object
      properties:
        id:
          type: integer
          format: int64
          nullable: true
        timestamp:
          type: string
          format: date-time
        method:
          type: string
        path:
          type: string
        request_type:
          type: string
        requested_model:
          type: string
          nullable: true
          description: 原始请求模型名（重定向前）
        effective_model:
          type: string
          nullable: true
          description: 实际上游模型名（重定向后）
        provider:
          type: string
          nullable: true
        api_key:
          type: string
          nullable: true
        client_token_id:
          type: string
          nullable: true
          description: Client Token ID（不可逆/非明文）
        client_token_name:
          type: string
          nullable: true
          description: Client Token 名称（用于展示）
        username:
          type: string
          nullable: true
          description: 该请求使用用户的 username（可关联到 client_token_id 时返回）
        amount_spent:
          type: number
          format: double
          nullable: true
        status_code:
          type: integer
        response_time_ms:
          type: integer
          format: int64
        prompt_tokens:
          type: integer
          nullable: true
        completion_tokens:
          type: integer
          nullable: true
        total_tokens:
          type: integer
          nullable: true
        cached_tokens:
          type: integer
          nullable: true
        reasoning_tokens:
          type: integer
          nullable: true
        error_message:
          type: string
          nullable: true
        success:
          type: boolean

    RequestLogsResponse:
      type: object
      properties:
        total:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/RequestLogEntry'
        next_cursor:
          type: integer
          format: int64
          nullable: true

    OperationLogEntry:
      type: object
      properties:
        id:
          type: integer
          format: int64
          nullable: true
        timestamp:
          type: string
          format: date-time
        operation:
          type: string
        provider:
          type: string
          nullable: true
        details:
          type: string
          nullable: true

    OperationLogsResponse:
      type: object
      properties:
        total:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/OperationLogEntry'
        next_cursor:
          type: integer
          format: int64
          nullable: true

    # 管理端：统计接口（/admin/metrics/*）
    TopItem:
      type: object
      properties:
        name:
          type: string
        count:
          type: integer

    MetricsSummary:
      type: object
      properties:
        window_minutes:
          type: integer
          format: int64
        total_requests:
          type: integer
        success_requests:
          type: integer
        error_requests:
          type: integer
        error_rate:
          type: number
          format: double
        average_latency_ms:
          type: number
          format: double
        p95_latency_ms:
          type: number
          format: double
          nullable: true
        total_amount_spent:
          type: number
          format: double
        total_tokens:
          type: integer
          format: int64
        unique_clients:
          type: integer
        top_providers:
          type: array
          items:
            $ref: '#/components/schemas/TopItem'
        top_models:
          type: array
          items:
            $ref: '#/components/schemas/TopItem'
        generated_at:
          type: string
          format: date-time
        start_date:
          type: string
          nullable: true
        end_date:
          type: string
          nullable: true
        available_dates:
          type: array
          items:
            type: string

    SeriesPoint:
      type: object
      properties:
        bucket_start:
          type: string
          format: date-time
        requests:
          type: integer
        errors:
          type: integer
        average_latency_ms:
          type: number
          format: double
        amount_spent:
          type: number
          format: double
        total_tokens:
          type: integer
          format: int64

    MetricsSeries:
      type: object
      properties:
        window_minutes:
          type: integer
          format: int64
        interval_minutes:
          type: integer
          format: int64
        points:
          type: array
          items:
            $ref: '#/components/schemas/SeriesPoint'
        generated_at:
          type: string
          format: date-time

    ModelCountItem:
      type: object
      properties:
        name:
          type: string
        count:
          type: integer

    ModelsDistributionResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ModelCountItem'
        generated_at:
          type: string
          format: date-time

    SeriesModelPoint:
      type: object
      properties:
        bucket_start:
          type: string
          format: date-time
        top_model:
          type: string
          nullable: true

    MetricsSeriesModels:
      type: object
      properties:
        window_minutes:
          type: integer
          format: int64
        interval_minutes:
          type: integer
          format: int64
        items:
          type: array
          items:
            $ref: '#/components/schemas/SeriesModelPoint'
        generated_at:
          type: string
          format: date-time

    # 客户端令牌（Client Token）
    ClientToken:
      type: object
      properties:
        id:
          type: string
          description: 令牌ID（非敏感标识，用于管理接口）
        user_id:
          type: string
          nullable: true
          description: 归属用户ID（为空表示存量/未绑定；仅 superadmin 可见/可管理）
        name:
          type: string
          description: 令牌名称
        token:
          type: string
          description: 令牌字符串
        allowed_models:
          type: array
          items:
            type: string
          nullable: true
          description: 允许使用的模型列表 (null 表示不限制)
        model_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: 禁止使用的模型列表 (null 表示不限制，与 allowed_models 互斥)
        max_tokens:
          type: integer
          format: int64
          nullable: true
          description: 最大 tokens 限制 (已废弃)
        max_amount:
          type: number
          format: double
          nullable: true
          description: 最大金额限制
        enabled:
          type: boolean
          description: 是否启用
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: 过期时间 (null 表示不过期)
        created_at:
          type: string
          format: date-time
          description: 创建时间
        amount_spent:
          type: number
          format: double
          description: 累计消费金额
        prompt_tokens_spent:
          type: integer
          format: int64
          description: 累计提示词 tokens
        completion_tokens_spent:
          type: integer
          format: int64
          description: 累计补全 tokens
        total_tokens_spent:
          type: integer
          format: int64
          description: 累计总 tokens
        remark:
          type: string
          nullable: true
          description: 备注
        organization_id:
          type: string
          nullable: true
          description: 所属组织 ID（字符串；为空表示默认组织 default）
        ip_whitelist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 白名单（JSON 数组，null 表示未设置）
        ip_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 黑名单（JSON 数组，null 表示未设置）
      required:
        - id
        - name
        - token
        - enabled
        - created_at
        - amount_spent
        - prompt_tokens_spent
        - completion_tokens_spent
        - total_tokens_spent

    # 用户
    User:
      type: object
      properties:
        id:
          type: string
          description: 用户ID
        first_name:
          type: string
          description: 名
        last_name:
          type: string
          description: 姓
        username:
          type: string
          description: 用户名
        email:
          type: string
          description: 邮箱
        phone_number:
          type: string
          description: 电话号码
        status:
          type: string
          enum: [active, inactive, invited, suspended]
          description: 用户状态
        role:
          type: string
          enum: [superadmin, admin, cashier, manager]
          description: 用户角色
        created_at:
          type: string
          format: date-time
          description: 创建时间
        updated_at:
          type: string
          format: date-time
          description: 更新时间
      required:
        - id
        - first_name
        - last_name
        - username
        - email
        - phone_number
        - status
        - role
        - created_at
        - updated_at

    CreateUserRequest:
      type: object
      properties:
        first_name:
          type: string
          nullable: true
        last_name:
          type: string
          nullable: true
        username:
          type: string
          nullable: true
        email:
          type: string
        phone_number:
          type: string
          nullable: true
        password:
          type: string
          nullable: true
        status:
          type: string
          enum: [active, inactive, invited, suspended]
          default: invited
        role:
          type: string
          enum: [superadmin, admin, cashier, manager]
          default: admin
      required:
        - email

    UpdateUserRequest:
      type: object
      properties:
        first_name:
          type: string
          nullable: true
        last_name:
          type: string
          nullable: true
        username:
          type: string
          nullable: true
        email:
          type: string
          nullable: true
        phone_number:
          type: string
          nullable: true
        password:
          type: string
          nullable: true
        status:
          type: string
          enum: [active, inactive, invited, suspended]
          nullable: true
        role:
          type: string
          enum: [superadmin, admin, cashier, manager]
          nullable: true

    # ==================== 认证（Auth） ====================
    ChallengeReq:
      type: object
      properties:
        fingerprint:
          type: string
      required:
        - fingerprint

    ChallengeResp:
      type: object
      properties:
        challenge_id:
          type: string
        nonce:
          type: string
        expires_at:
          type: string
          format: date-time
        alg:
          type: string

    VerifyReq:
      type: object
      properties:
        challenge_id:
          type: string
        fingerprint:
          type: string
        signature:
          type: string
      required:
        - challenge_id
        - fingerprint
        - signature

    VerifyResp:
      type: object
      properties:
        token:
          type: string
          description: AdminTuiSessionToken（bearer）
        expires_at:
          type: string
          format: date-time
        fingerprint:
          type: string

    JwtLoginRequest:
      type: object
      properties:
        email:
          type: string
        password:
          type: string
      required:
        - email
        - password

    JwtRegisterRequest:
      type: object
      properties:
        bootstrap_code:
          type: string
          description: 首次注册 bootstrap code（来自服务端环境变量 `GATEWAY_BOOTSTRAP_CODE`）
        first_name:
          type: string
          nullable: true
        last_name:
          type: string
          nullable: true
        username:
          type: string
          nullable: true
        email:
          type: string
        phone_number:
          type: string
          nullable: true
        password:
          type: string
      required:
        - bootstrap_code
        - email
        - password

    JwtAuthUser:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          nullable: true
          description: 显示名称（由 first_name/last_name 组合）
        username:
          type: string
          nullable: true
        bio:
          type: string
          nullable: true
        theme:
          type: string
          nullable: true
          enum: [light, dark, system]
        font:
          type: string
          nullable: true
          enum: [inter, manrope, system]
        email:
          type: string
        role:
          type: string
          enum: [superadmin, admin, cashier, manager]
        permissions:
          type: array
          items:
            type: string
      required:
        - id
        - email
        - role
        - permissions

    JwtPatchMeRequest:
      type: object
      properties:
        name:
          type: string
          nullable: true
          description: 显示名称（会写入用户表 first_name；best-effort 清空 last_name）
        username:
          type: string
          nullable: true
        bio:
          type: string
          nullable: true
        theme:
          type: string
          nullable: true
          enum: [light, dark, system]
        font:
          type: string
          nullable: true
          enum: [inter, manrope, system]

    JwtLoginResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: AccessToken（JWT）
        refreshToken:
          type: string
          description: RefreshToken（仅用于刷新 AccessToken；服务端仅存储 hash）
        expiresAt:
          type: string
          format: date-time
        refreshExpiresAt:
          type: string
          format: date-time
        user:
          $ref: '#/components/schemas/JwtAuthUser'
      required:
        - accessToken
        - refreshToken
        - expiresAt
        - refreshExpiresAt
        - user

    JwtRefreshRequest:
      type: object
      properties:
        refreshToken:
          type: string
      required:
        - refreshToken

    JwtRefreshResponse:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresAt:
          type: string
          format: date-time
        refreshExpiresAt:
          type: string
          format: date-time
      required:
        - accessToken
        - refreshToken
        - expiresAt
        - refreshExpiresAt

    JwtLogoutRequest:
      type: object
      properties:
        refreshToken:
          type: string

    JwtMeResponse:
      type: object
      properties:
        expiresAt:
          type: string
          format: date-time
        user:
          $ref: '#/components/schemas/JwtAuthUser'
      required:
        - expiresAt
        - user

    JwtRegisterResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/JwtAuthUser'
      required:
        - user

    AdminKey:
      type: object
      properties:
        fingerprint:
          type: string
        comment:
          type: string
          nullable: true
        enabled:
          type: boolean
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
          nullable: true

    AddAdminKeyRequest:
      type: object
      properties:
        public_key_b64:
          type: string
        comment:
          type: string
          nullable: true
        enabled:
          type: boolean
          nullable: true
      required:
        - public_key_b64

    CreateLoginCodeRequest:
      type: object
      properties:
        ttl_secs:
          type: integer
          format: int64
          description: 有效期秒数（默认 60）
        max_uses:
          type: integer
          format: int64
          description: 最大使用次数（默认 1）
        length:
          type: integer
          format: int64
          description: code 长度（25..=64）
        magic_url:
          type: boolean
          description: 是否返回 login_url

    CreateLoginCodeResponse:
      type: object
      properties:
        code:
          type: string
        expires_at:
          type: string
          format: date-time
        max_uses:
          type: integer
          format: int64
        uses:
          type: integer
          format: int64
        remaining_uses:
          type: integer
          format: int64
        login_url:
          type: string
          nullable: true

    CodeStatusInfo:
      type: object
      properties:
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        max_uses:
          type: integer
          format: int64
        uses:
          type: integer
          format: int64
        remaining_uses:
          type: integer
          format: int64
        disabled:
          type: boolean

    CodeStatusResponse:
      type: object
      properties:
        exists:
          type: boolean
        info:
          $ref: '#/components/schemas/CodeStatusInfo'
          nullable: true

    RedeemCodeRequest:
      type: object
      properties:
        code:
          type: string
      required:
        - code

    SessionInfo:
      type: object
      properties:
        valid:
          type: boolean
        user:
          type: object
          nullable: true
          properties:
            name:
              type: string

    TuiSession:
      type: object
      properties:
        session_id:
          type: string
        fingerprint:
          type: string
        issued_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        revoked:
          type: boolean
        last_code_at:
          type: string
          format: date-time
          nullable: true

    # 创建令牌请求
    CreateTokenRequest:
      type: object
      properties:
        user_id:
          type: string
          nullable: true
          description: 绑定归属用户 ID（可选；为空则创建为服务 token/未绑定 token；创建后不可修改）
        name:
          type: string
          nullable: true
          description: 令牌名称（可选，不填则自动生成）
        allowed_models:
          type: array
          items:
            type: string
          nullable: true
          description: 允许使用的模型列表
        model_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: 禁止使用的模型列表（与 allowed_models 互斥）
        max_amount:
          type: number
          format: double
          nullable: true
          description: 最大金额限制
        enabled:
          type: boolean
          default: true
          description: 是否启用
        expires_at:
          type: string
          nullable: true
          description: 过期时间（优先 ISO-8601 / RFC3339；兼容旧格式 YYYY-MM-DD HH:mm:ss 按北京时间解释）
        remark:
          type: string
          nullable: true
          description: 备注
        organization_id:
          type: string
          nullable: true
          description: 所属组织 ID（字符串；为空表示默认组织 default）
        ip_whitelist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 白名单（JSON 数组）
        ip_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 黑名单（JSON 数组）

    # 用户侧令牌（不返回 token 明文）
    MyToken:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        allowed_models:
          type: array
          items:
            type: string
          nullable: true
        model_blacklist:
          type: array
          items:
            type: string
          nullable: true
        max_tokens:
          type: integer
          format: int64
          nullable: true
        max_amount:
          type: number
          format: double
          nullable: true
        amount_spent:
          type: number
          format: double
        prompt_tokens_spent:
          type: integer
          format: int64
        completion_tokens_spent:
          type: integer
          format: int64
        total_tokens_spent:
          type: integer
          format: int64
        usage_count:
          type: integer
          format: int64
        enabled:
          type: boolean
        expires_at:
          type: string
          nullable: true
        created_at:
          type: string

    CreateMyTokenRequest:
      type: object
      properties:
        name:
          type: string
          nullable: true
        allowed_models:
          type: array
          items:
            type: string
          nullable: true
        model_blacklist:
          type: array
          items:
            type: string
          nullable: true
        max_tokens:
          type: integer
          format: int64
          nullable: true
        max_amount:
          type: number
          format: double
          nullable: true
        enabled:
          type: boolean
          default: true
        expires_at:
          type: string
          nullable: true

    CreateMyTokenResponse:
      type: object
      required:
        - token
        - token_info
      properties:
        token:
          type: string
          description: 仅创建时返回一次的 token 明文
        token_info:
          $ref: '#/components/schemas/MyToken'

    ToggleTokenRequest:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean

    ChangePasswordRequest:
      type: object
      required:
        - oldPassword
        - newPassword
      properties:
        oldPassword:
          type: string
        newPassword:
          type: string

    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    ResetPasswordRequest:
      type: object
      required:
        - token
        - newPassword
      properties:
        token:
          type: string
        newPassword:
          type: string

    # 更新令牌请求
    UpdateTokenRequest:
      type: object
      description: 本接口为部分更新：字段缺失=不修改；字段为 null=清空；字段为具体值=更新为该值。
      properties:
        name:
          type: string
          nullable: true
          description: 令牌名称（可选）
        allowed_models:
          type: array
          items:
            type: string
          nullable: true
          description: 允许使用的模型列表
        model_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: 禁止使用的模型列表（null 表示清空，与 allowed_models 互斥）
        max_amount:
          type: number
          format: double
          nullable: true
          description: 最大金额限制
        enabled:
          type: boolean
          nullable: true
          description: 是否启用
        expires_at:
          type: string
          nullable: true
          description: 过期时间（优先 ISO-8601 / RFC3339；兼容旧格式 YYYY-MM-DD HH:mm:ss 按北京时间解释）
        remark:
          type: string
          nullable: true
          description: 备注（null 表示清空）
        organization_id:
          type: string
          nullable: true
          description: 所属组织 ID（字符串；null 表示使用默认组织 default）
        ip_whitelist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 白名单（null 表示清空）
        ip_blacklist:
          type: array
          items:
            type: string
          nullable: true
          description: IP 黑名单（null 表示清空）

    # 提供商
    Provider:
      type: object
      properties:
        name:
          type: string
          description: 提供商名称
        api_type:
          type: string
          enum: [openai, anthropic, zhipu]
          description: 提供商类型
        base_url:
          type: string
          description: API 基础 URL
        api_keys:
          type: array
          items:
            type: string
          description: API Keys 列表
        models_endpoint:
          type: string
          nullable: true
          description: 模型列表端点
        enabled:
          type: boolean
          description: 是否启用（禁用后调度不会选择该提供商）
        created_at:
          type: string
          format: date-time
          nullable: true
          description: 创建时间（UTC）
        updated_at:
          type: string
          format: date-time
          nullable: true
          description: 更新时间（UTC）
      required:
        - name
        - api_type
        - base_url
        - api_keys
        - enabled

    ProviderModelsListRequest:
      type: object
      properties:
        api_type:
          type: string
          enum: [openai, anthropic, zhipu]
          description: 提供商类型
        base_url:
          type: string
          description: 上游 API 基础 URL（仅允许 http/https，禁止本机/内网）
        models_endpoint:
          type: string
          nullable: true
          description: |
            可选：自定义模型列表端点。
            - 以 `/` 开头：将拼接到 base_url
            - 以 `http(s)://` 开头：使用该完整 URL（会单独进行 SSRF 校验）
        provider:
          type: string
          nullable: true
          description: |
            可选：已存在的提供商名称（用于从后端选择一个可用 Key 进行请求）。
        api_key:
          type: string
          nullable: true
          description: |
            可选：临时 Key（仅用于本接口查询模型列表；后端不会保存，也不会写入日志）。
          writeOnly: true
      required:
        - api_type
        - base_url

    ProviderModelsListResponse:
      type: object
      properties:
        models:
          type: array
          items:
            type: string
          description: 模型 ID 列表
        raw_count:
          type: integer
          description: 上游返回（去重后）的模型数量
        cached:
          type: boolean
          description: 是否命中后端短 TTL 缓存
      required:
        - models
        - raw_count
        - cached

    # 模型
    Model:
      type: object
      properties:
        id:
          type: string
          description: 模型ID
        object:
          type: string
          description: 对象类型
        created:
          type: integer
          format: int64
          description: 创建时间戳
        owned_by:
          type: string
          description: 所有者
      required:
        - id
        - object
        - created
        - owned_by

    # 模型列表响应
    ModelsResponse:
      type: object
      properties:
        object:
          type: string
          default: list
        data:
          type: array
          items:
            $ref: '#/components/schemas/Model'
      required:
        - object
        - data

    # 聊天补全请求
    ChatCompletionRequest:
      type: object
      properties:
        model:
          type: string
          description: "模型名称 (格式: provider/model 或 model)"
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [system, user, assistant]
              content:
                type: string
          description: 消息列表
        stream:
          type: boolean
          default: false
          description: 是否使用流式响应
        temperature:
          type: number
          format: float
          nullable: true
          description: 温度参数
        max_tokens:
          type: integer
          nullable: true
          description: 最大生成 tokens
        top_p:
          type: number
          format: float
          nullable: true
          description: Top-p 采样参数
        top_k:
          type: integer
          nullable: true
          description: Top-k 采样参数（尽力而为：目前仅 Anthropic 生效）
      required:
        - model
        - messages

    # 聊天补全响应
    ChatCompletionResponse:
      type: object
      properties:
        id:
          type: string
          description: 响应ID
        object:
          type: string
          default: chat.completion
        created:
          type: integer
          format: int64
          description: 创建时间戳
        model:
          type: string
          description: 使用的模型
        choices:
          type: array
          items:
            type: object
            properties:
              index:
                type: integer
              message:
                type: object
                properties:
                  role:
                    type: string
                  content:
                    type: string
              finish_reason:
                type: string
        usage:
          type: object
          properties:
            prompt_tokens:
              type: integer
            completion_tokens:
              type: integer
            total_tokens:
              type: integer

    # 令牌余额响应（/v1/token/balance）
    TokenBalanceResponse:
      type: object
      properties:
        token:
          type: string
          description: Client Token（明文）
        amount_spent:
          type: number
          format: double
          description: 已消费金额
        max_amount:
          type: number
          format: double
          nullable: true
          description: 最大金额限制（可选）
        remaining:
          type: number
          format: double
          nullable: true
          description: 剩余金额（可选）
        total_tokens_spent:
          type: integer
          format: int64
          description: 累计总 tokens
        max_tokens:
          type: integer
          format: int64
          nullable: true
          description: 最大 tokens 限制（可选，兼容字段）

    # 令牌用量响应（/v1/token/usage）
    TokenUsageResponse:
      type: object
      properties:
        token:
          type: string
          description: Client Token（明文）
        limit:
          type: integer
          description: 返回条数
        total_cost:
          type: number
          format: double
          description: 累计消费金额
        prompt_tokens_spent:
          type: integer
          format: int64
          description: 累计提示/输入 tokens
        completion_tokens_spent:
          type: integer
          format: int64
          description: 累计补全/回复 tokens
        total_tokens_spent:
          type: integer
          format: int64
          description: 累计总 tokens
        items:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
                description: 时间（ISO-8601 / RFC3339）
              provider:
                type: string
                nullable: true
              model:
                type: string
                nullable: true
              status_code:
                type: integer
              response_time_ms:
                type: integer
              prompt_tokens:
                type: integer
                nullable: true
              completion_tokens:
                type: integer
                nullable: true
              total_tokens:
                type: integer
                nullable: true
              amount_spent:
                type: number
                format: double
                nullable: true
              error_message:
                type: string
                nullable: true

    # 模型缓存列表（/admin/models/cache）
    CachedModelEntry:
      type: object
      properties:
        id:
          type: string
        provider:
          type: string
        object:
          type: string
        created:
          type: integer
          format: int64
        owned_by:
          type: string
        cached_at:
          type: string
          format: date-time

    CachedModelsResponse:
      type: object
      properties:
        total:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/CachedModelEntry'

paths:
  # ==================== 管理端认证接口 ====================
  /auth/tui/challenge:
    post:
      summary: 请求 TUI 登录挑战
      description: 发起 Challenge-Response 流程第一步（公开接口）
      operationId: requestTuiChallenge
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChallengeReq'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChallengeResp'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/tui/verify:
    post:
      summary: 验证 TUI 登录挑战
      description: Challenge-Response 流程第二步，验证签名后签发管理员 TUI Session Token（公开接口）
      operationId: verifyTuiChallenge
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyReq'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyResp'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      summary: 管理端登录（JWT）
      description: |
        使用用户表中的 `email + password` 登录并签发 AccessToken（JWT）与 RefreshToken（用于无感续期）。
        需要配置：`GW_JWT_SECRET`（可选 `GW_JWT_TTL_SECS`）。
      operationId: authLogin
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JwtLoginRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtLoginResponse'
        '400':
          description: 配置/参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 登录失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/refresh:
    post:
      summary: 刷新 AccessToken（JWT）
      description: |
        使用 RefreshToken 刷新 AccessToken，并进行 refresh token rotation：
        - 成功时签发新的 AccessToken 与新的 RefreshToken
        - 旧 RefreshToken 会被服务端撤销（不可再次使用）
      operationId: authRefresh
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JwtRefreshRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtRefreshResponse'
        '401':
          description: RefreshToken 缺失/无效/过期/已撤销
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/register:
    post:
      summary: 初始化注册（仅首次）
      description: |
        当 `users` 表为空时允许创建第一个用户，并自动赋予 `superadmin` 角色（仅首次可用）。
        需要提供 bootstrap code（来自服务端环境变量 `GATEWAY_BOOTSTRAP_CODE`）。
        注册成功后，可通过 `/auth/login` 登录签发 AccessToken（JWT）。
      operationId: authRegister
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JwtRegisterRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtRegisterResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: bootstrap code 缺失/无效（或服务端未配置）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 系统已初始化（禁止再次注册）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/me:
    get:
      summary: 获取当前登录用户（JWT）
      description: 从 Authorization Bearer JWT 解析并返回当前用户信息
      operationId: authMe
      tags:
        - Auth
      security:
        - AccessToken: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtMeResponse'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: 更新当前登录用户（JWT）
      description: |
        更新当前用户的可编辑信息与外观偏好（部分字段可选，按需 patch）。
        `username` 若与其他用户冲突会返回 400（可读 message）。
      operationId: authPatchMe
      tags:
        - Auth
      security:
        - AccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JwtPatchMeRequest'
      responses:
        '200':
          description: 成功响应（返回更新后的用户）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JwtAuthUser'
        '400':
          description: 参数错误/username 冲突
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/change-password:
    post:
      summary: 修改密码（已登录）
      description: 已登录用户输入 oldPassword/newPassword 修改自己的密码
      operationId: authChangePassword
      tags:
        - Auth
      security:
        - AccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '204':
          description: 修改成功
        '400':
          description: 请求参数错误/旧密码不正确
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/forgot-password:
    post:
      summary: 忘记密码（发送重置邮件）
      description: |
        输入注册邮箱触发找回流程；无论邮箱是否存在，恒返回 204（防信息泄露）。
        重置链接为一次性且可过期，服务端仅存 token hash。
      operationId: authForgotPassword
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '204':
          description: 已触发（不泄露邮箱是否存在）

  /auth/reset-password:
    post:
      summary: 重置密码（通过邮件 token）
      description: |
        校验 reset token（存在/未使用/未过期）后更新用户密码，并撤销该用户全部 refresh tokens，强制重新登录。
      operationId: authResetPassword
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '204':
          description: 重置成功（需重新登录）
        '400':
          description: 请求参数错误（如密码过短）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: reset token 无效/过期/已使用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/keys:
    get:
      summary: 获取管理员公钥列表
      description: 管理员身份接口（Admin Identity）
      operationId: listAdminKeys
      tags:
        - Auth
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AdminKey'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 添加管理员公钥
      description: 管理员身份接口（Admin Identity）
      operationId: addAdminKey
      tags:
        - Auth
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddAdminKeyRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminKey'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/keys/{fingerprint}:
    delete:
      summary: 删除管理员公钥
      description: 管理员身份接口（Admin Identity）
      operationId: deleteAdminKey
      tags:
        - Auth
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: fingerprint
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/tui/sessions:
    get:
      summary: 获取 TUI 会话列表
      description: 管理员身份接口（Admin Identity）
      operationId: listTuiSessions
      tags:
        - Auth
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: fingerprint
          in: query
          schema:
            type: string
          description: 指纹筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TuiSession'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/tui/sessions/{session_id}/revoke:
    post:
      summary: 撤销 TUI 会话
      description: 管理员身份接口（Admin Identity）
      operationId: revokeTuiSession
      tags:
        - Auth
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  revoked:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login-codes:
    post:
      summary: 创建登录凭证
      description: 仅允许通过管理员 TUI Session Token 创建（不支持 Cookie 会话）
      operationId: createLoginCode
      tags:
        - Auth
      security:
        - AdminTuiSessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLoginCodeRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateLoginCodeResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login-codes/status:
    get:
      summary: 查询当前登录凭证状态
      description: 仅允许通过管理员 TUI Session Token 查询（不支持 Cookie 会话）
      operationId: getLoginCodeStatus
      tags:
        - Auth
      security:
        - AdminTuiSessionToken: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CodeStatusResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/code/redeem:
    post:
      summary: 兑换登录凭证
      description: 兑换成功后通过 Set-Cookie 设置 `gw_session`（公开接口）
      operationId: redeemLoginCode
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RedeemCodeRequest'
      responses:
        '204':
          description: "成功（Set-Cookie: gw_session=...）"
        '400':
          description: 请求参数错误/兑换失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/session:
    get:
      summary: 查询当前 Cookie 会话
      description: 根据 `gw_session` Cookie 判断是否已登录（公开接口）
      operationId: getWebSession
      tags:
        - Auth
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionInfo'

  /auth/logout:
    post:
      summary: 退出登录
      description: |
        - Cookie 会话：撤销 `gw_session` 并清理 Cookie
        - RefreshToken：服务端撤销该 RefreshToken（即 server-side revocation），后续 `/auth/refresh` 将返回 401
        - AccessToken（JWT）：无状态（本 P2 不做 access token revocation），前端自行清理本地 Token
      operationId: logout
      tags:
        - Auth
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JwtLogoutRequest'
      responses:
        '204':
          description: 成功（Set-Cookie 清理 gw_session）

  # ==================== OpenAI 兼容接口 ====================
  /v1/chat/completions:
    post:
      summary: 聊天补全
      description: 创建聊天补全请求，支持流式和非流式响应
      operationId: createChatCompletion
      tags:
        - Chat
      security:
        - ClientToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompletionRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompletionResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE 流式响应
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/models:
    get:
      summary: 获取模型列表
      description: 获取所有可用的模型列表（支持 Client Token；已登录管理员身份也可访问）
      operationId: listModels
      tags:
        - Models
      security:
        - ClientToken: []
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /models/{provider}:
    get:
      summary: 获取指定提供商模型列表
      description: 获取指定提供商的模型列表缓存；`refresh=true` 时拉取上游并返回（不落库）
      operationId: listProviderModels
      tags:
        - Models
      security:
        - ClientToken: []
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
        - name: refresh
          in: query
          schema:
            type: boolean
          description: 是否从上游刷新（返回但不写入缓存）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/token/balance:
    get:
      summary: 获取令牌余额
      description: 获取当前令牌的余额和使用情况
      operationId: getTokenBalance
      tags:
        - Token
      security:
        - ClientToken: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenBalanceResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /v1/token/usage:
    get:
      summary: 获取令牌用量
      description: 获取当前 Client Token 的最近聊天用量明细与累计统计
      operationId: getTokenUsage
      tags:
        - Token
      security:
        - ClientToken: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: 返回条数（1..200）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenUsageResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /model-prices:
    get:
      summary: 获取模型价格（只读）
      description: 公开只读的模型价格列表（可选按 provider 过滤）
      operationId: listModelPricesPublic
      tags:
        - Public
      parameters:
        - name: provider
          in: query
          required: false
          schema:
            type: string
          description: Provider 名称（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    provider:
                      type: string
                    model:
                      type: string
                    prompt_price_per_million:
                      type: number
                      format: double
                    completion_price_per_million:
                      type: number
                      format: double
                    currency:
                      type: string
                      nullable: true
                    model_type:
                      type: string
                      nullable: true

  /me/models:
    get:
      summary: 获取我的可用模型列表（只读）
      description: 返回当前登录用户已绑定且当前可使用的模型列表（只读；用于前端展示）
      operationId: listMyModels
      tags:
        - Me
      security:
        - AccessToken: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    model_id:
                      type: string
                    model_type:
                      type: string
                      nullable: true
                    provider:
                      type: string
                    provider_id:
                      type: string
                    provider_enabled:
                      type: boolean
                    upstream_endpoint_type:
                      type: string
                    input_price:
                      type: number
                      format: double
                      nullable: true
                    output_price:
                      type: number
                      format: double
                      nullable: true
                    redirect_name:
                      type: string
                    status:
                      type: string
                    created_at:
                      type: string
                    is_favorite:
                      type: boolean
                    tokens:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          name:
                            type: string
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/tokens:
    get:
      summary: 获取我的令牌列表
      operationId: listMyTokens
      tags:
        - Me
      security:
        - AccessToken: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MyToken'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      summary: 创建我的令牌（返回 token 明文一次）
      operationId: createMyToken
      tags:
        - Me
      security:
        - AccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMyTokenRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateMyTokenResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/tokens/{id}:
    get:
      summary: 获取我的令牌详情
      operationId: getMyToken
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MyToken'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      summary: 更新我的令牌
      operationId: updateMyToken
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTokenRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MyToken'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: 删除我的令牌
      operationId: deleteMyToken
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 删除成功
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/tokens/{id}/toggle:
    post:
      summary: 启用/禁用我的令牌
      operationId: toggleMyToken
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ToggleTokenRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MyToken'
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/token/balance:
    get:
      summary: 获取我的余额
      description: 返回当前用户的余额（按 token 汇总）；可选传 token_id 查询单个 token
      operationId: getMyTokenBalance
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: token_id
          in: query
          required: false
          schema:
            type: string
          description: 可选 token_id
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /me/token/usage:
    get:
      summary: 获取我的用量日志
      description: 返回当前用户的聊天用量日志（按 token 聚合）；可选传 token_id 只查询单个 token
      operationId: getMyTokenUsage
      tags:
        - Me
      security:
        - AccessToken: []
      parameters:
        - name: token_id
          in: query
          required: false
          schema:
            type: string
          description: 可选 token_id
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
          description: 返回条数（1..200）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
        '401':
          description: 未登录/Token 无效/过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: token 不存在或不属于当前用户
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 管理员接口 ====================
  /admin/tokens:
    get:
      summary: 获取令牌列表
      description: 获取所有客户端令牌（Client Token）列表
      operationId: listClientTokens
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientToken'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 创建令牌
      description: 创建新的客户端令牌（Client Token）
      operationId: createClientToken
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTokenRequest'
      responses:
        '201':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientToken'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/tokens/{id}:
    get:
      summary: 获取令牌详情
      description: 获取指定令牌的详细信息
      operationId: getClientToken
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 令牌ID
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientToken'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 令牌不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: 更新令牌
      description: 更新指定令牌的配置
      operationId: updateClientToken
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 令牌ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTokenRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientToken'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 令牌不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除令牌
      description: 删除指定的客户端令牌（Client Token）
      operationId: deleteClientToken
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 令牌ID
      responses:
        '204':
          description: 成功删除
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 令牌不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/tokens/{id}/toggle:
    post:
      summary: 启用/禁用令牌
      description: 启用或禁用指定令牌
      operationId: toggleClientToken
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 令牌ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
              required:
                - enabled
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/users:
    get:
      summary: 获取用户列表
      description: 获取所有用户列表
      operationId: listAdminUsers
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 创建用户
      description: 创建新用户
      operationId: createAdminUser
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/users/{id}:
    get:
      summary: 获取用户详情
      description: 获取指定用户信息
      operationId: getAdminUser
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 用户ID
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 用户不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: 更新用户
      description: 更新指定用户信息（部分字段可选）
      operationId: updateAdminUser
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 用户ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 用户不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除用户
      description: 删除指定用户
      operationId: deleteAdminUser
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: 用户ID
      responses:
        '204':
          description: 删除成功
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 用户不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 提供商管理接口 ====================
  /providers:
    get:
      summary: 获取提供商列表
      description: 获取所有AI提供商列表
      operationId: listProviders
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Provider'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 创建提供商
      description: 创建新的AI提供商配置
      operationId: createProvider
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: 提供商名称
                api_type:
                  type: string
                  enum: [openai, anthropic, zhipu]
                  description: 提供商类型
                base_url:
                  type: string
                  description: API 基础 URL
                models_endpoint:
                  type: string
                  nullable: true
                  description: 模型列表端点
              required:
                - name
                - api_type
                - base_url
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Provider'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/models/list:
    post:
      summary: 通过 base_url 获取可用模型列表
      description: |
        根据 api_type + base_url（以及可选 models_endpoint / provider / 临时 api_key）向上游查询模型列表。
        - 安全：仅允许 http/https，禁止本机/内网地址；禁用重定向
        - 兼容：OpenAI 默认查询 `/v1/models`（若 base_url 以 `/v1` 结尾则查询 `/models`）
        - 其他类型：未提供 models_endpoint 时返回友好提示
      operationId: listProviderModelsByBaseUrl
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProviderModelsListRequest'
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderModelsListResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}:
    get:
      summary: 获取提供商详情
      description: 获取指定提供商的详细信息
      operationId: getProvider
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Provider'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: 更新提供商
      description: 更新指定提供商的配置
      operationId: updateProvider
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                api_type:
                  type: string
                  enum: [openai, anthropic, zhipu]
                base_url:
                  type: string
                models_endpoint:
                  type: string
                  nullable: true
              required:
                - api_type
                - base_url
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Provider'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除提供商
      description: 删除指定的提供商配置
      operationId: deleteProvider
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功删除
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/toggle:
    post:
      summary: 启用/禁用提供商
      description: 设置指定提供商是否启用（禁用后调度层不会再选择该提供商）
      operationId: toggleProvider
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: true=启用，false=禁用
              required:
                - enabled
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/providers/{provider}/keys/stats:
    get:
      summary: 获取提供商密钥统计（按统计口径）
      description: |
        返回该提供商下各密钥在指定统计口径内的请求统计（总请求/成功/失败/可用率）。

        优先级（从高到低）：
        1) `range`
        2) `start_date`/`end_date`
        3) `window_minutes`
      operationId: getAdminProviderKeysStats
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
        - name: range
          in: query
          schema:
            type: string
            enum: [hour, day, week, since_created]
          description: 统计口径（可选；优先级最高）
        - name: window_minutes
          in: query
          schema:
            type: integer
            default: 60
            minimum: 1
            maximum: 10080
          description: 统计窗口（分钟；未指定 range/start_date/end_date 时生效）
        - name: start_date
          in: query
          schema:
            type: string
          description: 开始日期（YYYY-MM-DD，可选）
        - name: end_date
          in: query
          schema:
            type: string
          description: 结束日期（YYYY-MM-DD，可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  window_minutes:
                    type: integer
                    format: int64
                    description: 统计窗口（分钟；range=since_created 时为 0）
                  start_date:
                    type: string
                    nullable: true
                  end_date:
                    type: string
                    nullable: true
                  generated_at:
                    type: string
                    format: date-time
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        masked_key:
                          type: string
                          description: 脱敏密钥（4+****+4）
                        total_requests:
                          type: integer
                          format: int64
                        success_count:
                          type: integer
                          format: int64
                        failure_count:
                          type: integer
                          format: int64
                        availability_rate:
                          type: integer
                          format: int32
                          minimum: 0
                          maximum: 100
                      required: [masked_key, total_requests, success_count, failure_count, availability_rate]
                required: [window_minutes, keys, generated_at]
              examples:
                hour:
                  summary: 近 1 小时
                  value:
                    window_minutes: 60
                    keys:
                      - masked_key: "sk-a***1234"
                        total_requests: 12
                        success_count: 10
                        failure_count: 2
                        availability_rate: 83
                    generated_at: "2025-01-01T00:00:00Z"
                since_created:
                  summary: 自创建以来
                  value:
                    window_minutes: 0
                    keys:
                      - masked_key: "sk-a***1234"
                        total_requests: 120
                        success_count: 110
                        failure_count: 10
                        availability_rate: 92
                    generated_at: "2025-01-01T00:00:00Z"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys:
    get:
      summary: 获取提供商密钥列表
      description: 获取指定提供商的所有API密钥
      operationId: listProviderKeys
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: string
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 添加提供商密钥
      description: 为指定提供商添加新的API密钥
      operationId: addProviderKey
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                key:
                  type: string
                  description: API密钥
              required:
                - key
      responses:
        '200':
          description: 成功添加
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除提供商密钥
      description: 删除指定提供商的API密钥
      operationId: deleteProviderKey
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                key:
                  type: string
                  description: 要删除的API密钥
              required:
                - key
      responses:
        '200':
          description: 成功删除
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商或密钥不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys/raw:
    get:
      summary: 获取提供商密钥列表（含原文）
      description: 返回原文密钥与脱敏展示（仅管理员身份可用）
      operationId: listProviderKeysRaw
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
        - name: q
          in: query
          schema:
            type: string
          description: 搜索关键字（可选，匹配原文或脱敏值）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        value:
                          type: string
                          description: 原文密钥
                        masked:
                          type: string
                          description: 脱敏密钥
                        active:
                          type: boolean
                          description: 是否启用
                        weight:
                          type: integer
                          minimum: 1
                          description: 权重（>=1）
                  total:
                    type: integer
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys/config:
    get:
      summary: 获取提供商密钥策略配置（含密钥列表）
      description: 返回该提供商的密钥轮询策略配置与密钥列表（含权重与启用状态）
      operationId: getProviderKeysConfig
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
        - name: q
          in: query
          schema:
            type: string
          description: 搜索关键字（可选，匹配原文或脱敏值）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  strategy:
                    type: string
                    enum: [sequential, random, weighted_sequential, weighted_random]
                    description: 当前密钥轮询策略
                  default_strategy:
                    type: string
                    enum: [sequential, random, weighted_sequential, weighted_random]
                    description: 默认策略
                  strategies:
                    type: array
                    items:
                      type: string
                      enum: [sequential, random, weighted_sequential, weighted_random]
                    description: 可选策略列表
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        value:
                          type: string
                          description: 原文密钥
                        masked:
                          type: string
                          description: 脱敏密钥
                        active:
                          type: boolean
                          description: 是否启用
                        weight:
                          type: integer
                          minimum: 1
                          description: 权重（>=1）
                  total:
                    type: integer
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: 更新提供商密钥轮询策略
      description: 更新该提供商的密钥轮询策略配置
      operationId: updateProviderKeyRotationStrategy
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                strategy:
                  type: string
                  enum: [sequential, random, weighted_sequential, weighted_random]
                  description: 密钥轮询策略
              required:
                - strategy
      responses:
        '200':
          description: 成功更新
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys/weight:
    patch:
      summary: 更新提供商单个密钥权重
      description: 根据原文密钥更新权重（权重必须为 >=1 的整数）
      operationId: updateProviderKeyWeight
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                key:
                  type: string
                  description: 原文API密钥
                weight:
                  type: integer
                  minimum: 1
                  description: 权重（>=1）
              required:
                - key
                - weight
      responses:
        '200':
          description: 成功更新
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商或密钥不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys/toggle:
    post:
      summary: 启用/禁用提供商密钥
      description: 按原文密钥切换 active 状态（禁用不删除）
      operationId: toggleProviderKey
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                key:
                  type: string
                  description: 原文API密钥
                active:
                  type: boolean
                  description: 是否启用
              required:
                - key
                - active
      responses:
        '200':
          description: 成功切换
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商或密钥不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/keys/batch:
    post:
      summary: 批量添加提供商密钥
      description: 批量添加密钥，逐条返回成功/失败
      operationId: addProviderKeysBatch
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                keys:
                  type: array
                  items:
                    type: string
              required:
                - keys
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  added:
                    type: integer
                  failed:
                    type: integer
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        key:
                          type: string
                        status:
                          type: string
                        message:
                          type: string
                          nullable: true
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 批量删除提供商密钥
      description: 批量删除密钥，逐条返回结果
      operationId: deleteProviderKeysBatch
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                keys:
                  type: array
                  items:
                    type: string
              required:
                - keys
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  deleted:
                    type: integer
                  missing:
                    type: integer
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        key:
                          type: string
                        status:
                          type: string
                        message:
                          type: string
                          nullable: true
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /providers/{provider}/model-redirects:
    get:
      summary: 获取提供商模型重定向规则
      description: 获取指定提供商的模型重定向映射（source_model -> target_model）
      operationId: listProviderModelRedirects
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  redirects:
                    type: object
                    additionalProperties:
                      type: string
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: 批量保存提供商模型重定向规则
      description: 以整表替换方式保存映射（会覆盖该提供商现有规则）
      operationId: replaceProviderModelRedirects
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                redirects:
                  type: object
                  additionalProperties:
                    type: string
              required:
                - redirects
      responses:
        '200':
          description: 保存成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除提供商模型重定向单条规则
      description: 删除指定 source_model 的规则（DELETE body 传入 source_model）
      operationId: deleteProviderModelRedirect
      tags:
        - Providers
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                source_model:
                  type: string
                  description: 源模型名称
              required:
                - source_model
      responses:
        '200':
          description: 删除结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 日志查询接口 ====================
  /admin/logs/requests:
    get:
      summary: 获取请求日志列表
      description: 获取系统请求日志（可筛选），支持分页游标
      operationId: listRequestLogs
      tags:
        - Logs
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 200
          description: 返回记录数量限制（1..1000）
        - name: cursor
          in: query
          schema:
            type: integer
            format: int64
          description: 分页游标（上一页最后一条记录的ID）
        - name: request_type
          in: query
          schema:
            type: string
          description: 请求类型筛选（可选）
        - name: provider
          in: query
          schema:
            type: string
          description: 提供商筛选（可选）
        - name: model
          in: query
          schema:
            type: string
          description: 模型筛选（可选；匹配 requested/effective/billing 任一字段）
        - name: client_token
          in: query
          schema:
            type: string
          description: Client Token ID 筛选（可选）
        - name: api_key
          in: query
          schema:
            type: string
          description: API Key（原文/脱敏）筛选（可选）
        - name: status
          in: query
          schema:
            type: string
            enum: [success, error]
          description: 状态筛选（可选）
        - name: method
          in: query
          schema:
            type: string
          description: HTTP 方法筛选（可选）
        - name: path
          in: query
          schema:
            type: string
          description: 路径筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestLogsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/logs/chat-completions:
    get:
      summary: 获取聊天补全日志列表
      description: 仅返回 `POST /v1/chat/completions` 的日志
      operationId: listChatCompletionLogs
      tags:
        - Logs
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 200
          description: 返回记录数量限制（1..1000）
        - name: cursor
          in: query
          schema:
            type: integer
            format: int64
          description: 分页游标（上一页最后一条记录的ID）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestLogsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/logs/operations:
    get:
      summary: 获取操作审计日志列表
      description: 获取提供商/密钥等管理操作日志，支持分页游标
      operationId: listOperationLogs
      tags:
        - Logs
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 200
          description: 返回记录数量限制（1..1000）
        - name: cursor
          in: query
          schema:
            type: integer
            format: int64
          description: 分页游标（上一页最后一条记录的ID）
        - name: operation
          in: query
          schema:
            type: string
          description: 操作类型筛选（可选）
        - name: provider
          in: query
          schema:
            type: string
          description: 提供商筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationLogsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 统计分析接口 ====================
  /admin/metrics/summary:
    get:
      summary: 获取统计摘要
      description: 统计窗口摘要（支持按日期范围或 window_minutes）
      operationId: getMetricsSummary
      tags:
        - Metrics
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: window_minutes
          in: query
          schema:
            type: integer
          description: 统计窗口（分钟，默认 60；1..1440）
        - name: start_date
          in: query
          schema:
            type: string
          description: 开始日期（YYYY-MM-DD，可选）
        - name: end_date
          in: query
          schema:
            type: string
          description: 结束日期（YYYY-MM-DD，可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSummary'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/metrics/series:
    get:
      summary: 获取统计时序
      description: 按 bucket 输出请求数、错误数、延迟、金额与 tokens
      operationId: getMetricsSeries
      tags:
        - Metrics
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: window_minutes
          in: query
          schema:
            type: integer
          description: 统计窗口（分钟，默认 60；1..1440）
        - name: interval_minutes
          in: query
          schema:
            type: integer
          description: bucket 粒度（分钟，默认 5）
        - name: start_date
          in: query
          schema:
            type: string
          description: 开始日期（YYYY-MM-DD，可选）
        - name: end_date
          in: query
          schema:
            type: string
          description: 结束日期（YYYY-MM-DD，可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSeries'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/metrics/models-distribution:
    get:
      summary: 获取模型分布
      description: 返回窗口内 top N 模型分布
      operationId: getModelsDistribution
      tags:
        - Metrics
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: window_minutes
          in: query
          schema:
            type: integer
          description: 统计窗口（分钟，默认 60；1..1440）
        - name: start_date
          in: query
          schema:
            type: string
          description: 开始日期（YYYY-MM-DD，可选）
        - name: end_date
          in: query
          schema:
            type: string
          description: 结束日期（YYYY-MM-DD，可选）
        - name: limit
          in: query
          schema:
            type: integer
          description: 返回条数（默认 8）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsDistributionResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/metrics/series-models:
    get:
      summary: 获取模型时序（Top1）
      description: 按时间 bucket 输出该 bucket 使用最多的模型（用于趋势展示）
      operationId: getSeriesModels
      tags:
        - Metrics
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: window_minutes
          in: query
          schema:
            type: integer
          description: 统计窗口（分钟，默认 60；1..1440）
        - name: interval_minutes
          in: query
          schema:
            type: integer
          description: bucket 粒度（分钟，默认 5）
        - name: start_date
          in: query
          schema:
            type: string
          description: 开始日期（YYYY-MM-DD，可选）
        - name: end_date
          in: query
          schema:
            type: string
          description: 结束日期（YYYY-MM-DD，可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSeriesModels'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 模型缓存接口 ====================
  /admin/models/cache:
    get:
      summary: 获取模型缓存列表
      description: 获取缓存的模型列表（可选按 provider 过滤）
      operationId: listCachedModels
      tags:
        - Models
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: query
          schema:
            type: string
          description: 按提供商筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CachedModelsResponse'
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/models/enabled:
    get:
      summary: 获取模型启用状态（管理员）
      description: 获取模型启用/禁用配置（可选按 provider 过滤）
      operationId: listAdminModelEnabled
      tags:
        - Models
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: query
          required: false
          schema:
            type: string
          description: 按提供商筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    provider:
                      type: string
                    model:
                      type: string
                    enabled:
                      type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      summary: 设置模型启用状态（管理员）
      description: 设置或更新指定 provider+model 的启用状态
      operationId: upsertAdminModelEnabled
      tags:
        - Models
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                provider:
                  type: string
                model:
                  type: string
                enabled:
                  type: boolean
              required:
                - provider
                - model
                - enabled
      responses:
        '200':
          description: 成功设置
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: provider 或 model 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /models/{provider}/cache:
    post:
      summary: 更新模型缓存
      description: 更新指定提供商的模型缓存
      operationId: updateModelCache
      tags:
        - Models
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功更新
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 提供商不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: 删除模型缓存
      description: 删除指定提供商的模型缓存
      operationId: deleteModelCache
      tags:
        - Models
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
          description: 提供商名称
      responses:
        '200':
          description: 成功删除
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ==================== 价格管理接口 ====================
  /admin/model-prices:
    get:
      summary: 获取模型价格列表
      description: 获取所有模型的价格配置
      operationId: listModelPrices
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: query
          schema:
            type: string
          description: 按提供商筛选（可选）
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    provider:
                      type: string
                    model:
                      type: string
                    prompt_price_per_million:
                      type: number
                      format: double
                    completion_price_per_million:
                      type: number
                      format: double
                    currency:
                      type: string
                      nullable: true
                    model_type:
                      type: string
                      nullable: true
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: 设置模型价格
      description: 设置或更新模型价格
      operationId: setModelPrice
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                provider:
                  type: string
                  description: 提供商名称
                model:
                  type: string
                  description: 模型名称
                prompt_price_per_million:
                  type: number
                  format: double
                  description: 每百万输入tokens价格
                completion_price_per_million:
                  type: number
                  format: double
                  description: 每百万输出tokens价格
                currency:
                  type: string
                  nullable: true
                  description: 货币单位
                model_type:
                  type: string
                  nullable: true
                  description: 模型类型（如 chat/image/embedding/audio 等）
              required:
                - provider
                - model
                - prompt_price_per_million
                - completion_price_per_million
      responses:
        '200':
          description: 成功设置
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/model-prices/{provider}/{model}:
    get:
      summary: 获取单个模型价格
      description: 获取指定提供商+模型的价格配置
      operationId: getModelPrice
      tags:
        - Admin
      security:
        - AccessToken: []
        - AdminTuiSessionToken: []
        - AdminSessionCookie: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
        - name: model
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                type: object
                properties:
                  provider:
                    type: string
                  model:
                    type: string
                  prompt_price_per_million:
                    type: number
                    format: double
                  completion_price_per_million:
                    type: number
                    format: double
                  currency:
                    type: string
                    nullable: true
                  model_type:
                    type: string
                    nullable: true
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 权限不足
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Chat
    description: 聊天补全相关接口
  - name: Models
    description: 模型管理相关接口
  - name: Token
    description: 令牌管理相关接口
  - name: Admin
    description: 管理员接口
  - name: Providers
    description: 提供商管理接口
  - name: Logs
    description: 日志查询接口
  - name: Metrics
    description: 统计分析接口
