# Token è¯¦è§£ï¼šä»€ä¹ˆæ˜¯ Client Tokenï¼Ÿ

## ğŸ« Token å°±åƒ"é—¨ç¥¨"æˆ–"æˆ¿å¡"

### ç”Ÿæ´»ç±»æ¯”

æƒ³è±¡ä½ å»é…’åº—ï¼š
1. **åŠç†å…¥ä½**æ—¶ï¼Œå‰å°ç»™ä½ ä¸€å¼ **æˆ¿å¡** â†’ è¿™å°±æ˜¯ Token
2. **ä½¿ç”¨æœåŠ¡**æ—¶ï¼Œä½ éœ€è¦**åˆ·æˆ¿å¡** â†’ è¿™å°±æ˜¯ API è°ƒç”¨æ—¶å¸¦ä¸Š Token
3. **å‰å°éªŒè¯**æˆ¿å¡æ˜¯å¦æœ‰æ•ˆ â†’ ç½‘å…³éªŒè¯ Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯åº”ç”¨   â”‚  â†â”€â”€ Tokenå¡ â”€â”€â†’  â”‚  ç½‘å…³æœåŠ¡å™¨   â”‚
â”‚ (ä½ çš„ç¨‹åº)   â”‚   "æˆ‘æœ‰æƒé™ï¼"     â”‚ (Gateway)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ åœ¨ Gateway Zero ä¸­ï¼ŒClient Token çš„ä½œç”¨

### 1. è®¿é—®å‡­è¯
```
å®¢æˆ·ç«¯è¯·æ±‚ï¼š
  "æˆ‘æƒ³è°ƒç”¨ GPT-4"
  
ç½‘å…³æ£€æŸ¥ï¼š
  "ä½ æ˜¯è°ï¼Ÿ" â†’ çœ‹ Token
  "Token: my-test-token-12345"
  
ç½‘å…³æŸ¥æ•°æ®åº“ï¼š
  "è¿™ä¸ª Token å­˜åœ¨å—ï¼Ÿ" â†’ âœ… å­˜åœ¨
  "è¿™ä¸ª Token å¯ç”¨äº†å—ï¼Ÿ" â†’ âœ… enabled = true
  "è¿™ä¸ª Token æœ‰é¢åº¦å—ï¼Ÿ" â†’ âœ… æ²¡è¶…é™
  
ç½‘å…³æ”¾è¡Œï¼š
  "å¥½çš„ï¼Œå¸®ä½ è°ƒç”¨ GPT-4"
```

### 2. æƒé™ä¸é¢åº¦æ§åˆ¶

ä¸€ä¸ª Token å¯ä»¥è®¾ç½®å¾ˆå¤šé™åˆ¶ï¼š

```sql
-- æ•°æ®åº“ä¸­çš„ Token è®°å½•
token                     | my-test-token-12345
allowed_models            | gpt-4,claude-3  (åªèƒ½ç”¨è¿™ä¸¤ä¸ªæ¨¡å‹)
max_amount                | 100.0           (æœ€å¤šèŠ± 100 å…ƒ)
enabled                   | 1               (å¯ç”¨çŠ¶æ€)
expires_at                | 2025-12-31      (è¿‡æœŸæ—¶é—´)
amount_spent              | 25.5            (å·²èŠ±è´¹ 25.5 å…ƒ)
```

### 3. ç”¨é‡ç»Ÿè®¡

ç½‘å…³ä¼šè®°å½•æ¯ä¸ª Token çš„ä½¿ç”¨æƒ…å†µï¼š
- ç”¨äº†å¤šå°‘ tokensï¼ˆè¾“å…¥ + è¾“å‡ºï¼‰
- èŠ±äº†å¤šå°‘é’±
- è°ƒç”¨äº†å“ªäº›æ¨¡å‹
- ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„

---

## ğŸ› ï¸ å¦‚ä½•åˆ›å»ºç¬¬ä¸€ä¸ª Client Tokenï¼Ÿ

### é—®é¢˜ï¼šé¸¡ç”Ÿè›‹ï¼Œè›‹ç”Ÿé¸¡

```
åœºæ™¯1ï¼šé€šè¿‡ç®¡ç†ç«¯ API åˆ›å»º Client Token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /admin/tokens                   â”‚
â”‚ Authorization: Bearer <admin_session>â”‚  â† éœ€è¦ç®¡ç†å‘˜èº«ä»½ï¼ˆTUI Session Token æˆ– Web Session Cookieï¼‰
â”‚ { "token": "new-token" }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯´æ˜ï¼š
- `/admin/*` ç”± **Admin Identity** ä¿æŠ¤ï¼ˆTUI Session Token æˆ– Web Session Cookieï¼‰ï¼Œä¸æ˜¯ Client Token
- `/v1/*` æ‰ä½¿ç”¨ **Client Token**
```

### è§£å†³æ–¹æ¡ˆï¼šç›´æ¥åœ¨æ•°æ®åº“åˆ›å»º

```
ç»•è¿‡ APIï¼Œç›´æ¥æ“ä½œæ•°æ®åº“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sqlite3 data/gateway.db              â”‚
â”‚ INSERT INTO client_tokens ...        â”‚  â† ç›´æ¥å†™å…¥æ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç°åœ¨æœ‰äº†ç¬¬ä¸€ä¸ª Client Token â†’ å¯ç”¨äºè°ƒç”¨ `/v1/*` âœ…
```

---

## ğŸ“ Token çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

### é˜¶æ®µ 1ï¼šåˆ›å»º Client Token

**æ–¹å¼ Aï¼šæ‰‹åŠ¨åˆ›å»ºï¼ˆç¬¬ä¸€ä¸ªï¼‰**
```bash
sqlite3 data/gateway.db
INSERT INTO client_tokens (name, token, ...) VALUES ('my-first-token', 'my-token', ...);
```

**æ–¹å¼ Bï¼šé€šè¿‡ç®¡ç†ç«¯ API åˆ›å»ºï¼ˆéœ€è¦ç®¡ç†å‘˜èº«ä»½ï¼‰**
```bash
curl -X POST http://localhost:8080/admin/tokens \
  -H "Authorization: Bearer <admin_tui_session_token>" \
  -d '{"max_amount": 50}'
```

### é˜¶æ®µ 2ï¼šä½¿ç”¨ Token

```bash
# æ¯æ¬¡è°ƒç”¨ API éƒ½éœ€è¦å¸¦ä¸Š Token
curl http://localhost:8080/v1/chat/completions \
  -H "Authorization: Bearer my-test-token-12345" \
  -d '{"model": "gpt-4", "messages": [...]}'
```

**ç½‘å…³çš„éªŒè¯æµç¨‹**ï¼š
```rust
// ä¼ªä»£ç 
1. ä» HTTP Header ä¸­æå– Token
   let token = extract_token("Authorization: Bearer my-test-token-12345");
   // token = "my-test-token-12345"

2. ä»æ•°æ®åº“æŸ¥è¯¢ Token
   let client_token = db.get_token(token).await?;
   
3. éªŒè¯ Token
   if !client_token.enabled {
       return Error("Token å·²ç¦ç”¨");
   }
   if client_token.expires_at < now() {
       return Error("Token å·²è¿‡æœŸ");
   }
   if client_token.amount_spent >= client_token.max_amount {
       return Error("Token é¢åº¦å·²ç”¨å®Œ");
   }
   
4. éªŒè¯é€šè¿‡ï¼Œå¤„ç†è¯·æ±‚
   let response = call_ai_provider(...);
   
5. æ›´æ–°ç»Ÿè®¡
   db.add_usage_spent(token, prompt_tokens, completion_tokens);
```

### é˜¶æ®µ 3ï¼šæŸ¥çœ‹ Token ä½¿ç”¨æƒ…å†µ

```bash
# æŸ¥çœ‹è‡ªå·±çš„ç”¨é‡
curl http://localhost:8080/v1/token/usage \
  -H "Authorization: Bearer my-test-token-12345"

# è¾“å‡º
{
  "total_tokens": 1250,
  "prompt_tokens": 800,
  "completion_tokens": 450,
  "amount_spent": 0.025
}
```

### é˜¶æ®µ 4ï¼šç®¡ç† Client Tokenï¼ˆç®¡ç†ç«¯ï¼‰

```bash
# ç¦ç”¨ Token
curl -X POST http://localhost:8080/admin/tokens/<token-id>/toggle \
  -H "Authorization: Bearer <admin_tui_session_token>"

# åˆ é™¤ Token
curl -X DELETE http://localhost:8080/admin/tokens/<token-id> \
  -H "Authorization: Bearer <admin_tui_session_token>"
```

---

## ğŸ” Token çš„å®‰å…¨æ€§

### Token çš„å½¢å¼
```
my-test-token-12345  â† è¿™æ˜¯æ˜æ–‡ï¼Œç±»ä¼¼å¯†ç 
```

### å­˜å‚¨ä½ç½®
- **æ•°æ®åº“**ï¼šæ˜æ–‡å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒåº”åŠ å¯†ï¼‰
- **å®¢æˆ·ç«¯**ï¼šé…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡
- **ä¼ è¾“**ï¼šHTTP Headerï¼ˆåº”ä½¿ç”¨ HTTPSï¼‰

### å®‰å…¨å»ºè®®

1. **ä½¿ç”¨ HTTPS**
   ```
   âŒ http://gateway.com  (Token æ˜æ–‡ä¼ è¾“ï¼Œå®¹æ˜“è¢«æˆªè·)
   âœ… https://gateway.com (åŠ å¯†ä¼ è¾“)
   ```

2. **å®šæœŸè½®æ¢ Token**
   ```bash
   # æ¯ä¸ªæœˆåˆ›å»ºæ–° Tokenï¼Œåˆ é™¤æ—§çš„
   curl -X POST /admin/tokens -d '{"expires_at": "2025-01-31"}'
   ```

3. **è®¾ç½®é¢åº¦é™åˆ¶**
   ```bash
   # é˜²æ­¢å•ä¸ª Token è¢«ç›—ç”¨åæŸå¤±è¿‡å¤§
   curl -X POST /admin/tokens -d '{"max_amount": 100.0}'
   ```

4. **ç›‘æ§å¼‚å¸¸**
   ```bash
   # å®šæœŸæ£€æŸ¥ Token ä½¿ç”¨æƒ…å†µ
   curl /admin/logs/requests | grep "my-token"
   ```

---

## ğŸ’¡ å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå›¢é˜Ÿåä½œ

```
å›¢é˜Ÿæˆå‘˜ Aï¼šToken-A (é¢åº¦ $50ï¼Œåªèƒ½ç”¨ gpt-3.5)
å›¢é˜Ÿæˆå‘˜ Bï¼šToken-B (é¢åº¦ $100ï¼Œå¯ä»¥ç”¨ gpt-4)
ç®¡ç†å‘˜èº«ä»½ï¼šAdmin Identityï¼ˆTUI Session / Web Sessionï¼‰
```

### åœºæ™¯ 2ï¼šä¸åŒåº”ç”¨

```
Web åº”ç”¨ï¼š   Token-Web
ç§»åŠ¨åº”ç”¨ï¼š   Token-Mobile
æµ‹è¯•ç¯å¢ƒï¼š   Token-Test (é¢åº¦å¾ˆå°ï¼Œé˜²æ­¢æµªè´¹)
```

### åœºæ™¯ 3ï¼šå®¢æˆ·è®¡è´¹

```
å®¢æˆ· 1ï¼šToken-Customer1 (é¢„å……å€¼ $100)
å®¢æˆ· 2ï¼šToken-Customer2 (é¢„å……å€¼ $50)
  â†“ ç”¨å®Œè‡ªåŠ¨åœç”¨
  â†“ éœ€è¦ç»­è´¹
```

---

## ğŸ¯ æ€»ç»“

### Token æ˜¯ä»€ä¹ˆï¼Ÿ
- ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºèº«ä»½è®¤è¯
- å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- å…³è”æƒé™ã€é¢åº¦ã€ç»Ÿè®¡ä¿¡æ¯

### ä¸ºä»€ä¹ˆéœ€è¦ Tokenï¼Ÿ
- **å®‰å…¨**ï¼šä¸ç›´æ¥æš´éœ² AI Provider çš„ API Key
- **ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å¤šä¸ªç”¨æˆ·/åº”ç”¨
- **ç»Ÿè®¡**ï¼šè¿½è¸ªæ¯ä¸ªç”¨æˆ·çš„ä½¿ç”¨æƒ…å†µ
- **é™é¢**ï¼šé˜²æ­¢è¶…æ”¯

### Token vs AI Provider API Key

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯                                              â”‚
â”‚    â†“ ä½¿ç”¨ Client Token (my-test-token-12345)      â”‚
â”‚  ç½‘å…³                                                â”‚
â”‚    â†“ ä½¿ç”¨ Provider API Key (sk-proj-xxx)          â”‚
â”‚  AI Provider (OpenAI/Anthropic)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼š
âœ… å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“çœŸå®çš„ AI API Key
âœ… å¯ä»¥åˆ‡æ¢ Providerï¼Œå®¢æˆ·ç«¯æ— æ„ŸçŸ¥
âœ… å¯ä»¥å¯¹å•ä¸ª Token é™é¢ï¼Œè€Œä¸æ˜¯æ•´ä¸ª API Key
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç†è§£äº† Token åï¼Œä½ å¯ä»¥ï¼š
1. ç»§ç»­ QUICK_START.md çš„æ­¥éª¤ 3-7
2. å°è¯•åˆ›å»ºå¤šä¸ª Tokenï¼Œè®¾ç½®ä¸åŒçš„æƒé™
3. æŸ¥çœ‹ Token çš„ä½¿ç”¨ç»Ÿè®¡
4. é˜…è¯»æºç ï¼š`src/server/handlers/auth.rs`

å¸Œæœ›è¿™ä¸ªè§£é‡Šæ¸…æ¥šäº†ï¼æœ‰ä»»ä½•é—®é¢˜éšæ—¶é—®æˆ‘ ğŸ˜Š
